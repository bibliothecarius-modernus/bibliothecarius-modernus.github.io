<!-- ENHANCED TABBED POST TEMPLATE WITH LOCAL STORAGE AND LAZY LOADING -->

{% comment %}
This is an improved version of tabbed_post.html that:
1. Implements a local storage caching mechanism for translation data
2. Uses lazy loading for audio files
3. Improves responsive design using modern CSS techniques
4. Fully eliminates dependency on Google Drive for content
{% endcomment %}

---
layout: default
---
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header content-container">
    <h1 class="post-title" itemprop="name headline">{{ page.title | escape }}</h1>
    <div class="post-meta">
      <time datetime="{{ page.date | date_to_xmlschema }}" itemprop="datePublished">
        {{ page.date | date: "%B %-d, %Y" }}
      </time>
      {% if page.author %}
        â€¢ <span itemprop="author" itemscope itemtype="http://schema.org/Person">
            <span itemprop="name">{{ page.author }}</span>
          </span>
      {% endif %}
      
      {% if page.categories %}
      <div class="post-categories">
        {% for category in page.categories %}
        <a href="{{ '/archive/#' | append: category | uri_escape | relative_url }}" class="category-tag" data-category="{{ category }}">{{ category }}</a>
        {% endfor %}
      </div>
      {% endif %}
    </div>
    
    {% if page.youtube_id %}
    <div class="youtube-embed responsive-embed">
      <iframe width="100%" height="500" src="https://www.youtube.com/embed/{{ page.youtube_id }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
    </div>
    {% elsif page.image %}
    <div class="post-featured-image">
      <img src="{{ page.image | relative_url }}" alt="{{ page.title | escape }}">
    </div>
    {% endif %}
  </header>

  {% if page.audio_analysis %}
  <div class="audio-player-container content-container">
    <details>
      <summary>Listen to Audio Analysis</summary>
      <div class="audio-player">
        <audio controls preload="none">
          <source src="{{ page.audio_analysis | relative_url }}" type="audio/mpeg">
          Your browser does not support the audio element.
        </audio>
        <p class="audio-description">Listen to a brief analysis of this text</p>
      </div>
    </details>
  </div>
  {% endif %}

  <!-- Improved Translation Viewer - With local storage caching -->
  <div id="translation-viewer" class="container">
    <!-- Tab buttons -->
    <div class="translation-tabs">
      <button class="tab-btn analysis-tab active" data-target="analysis">Analysis</button>
      <button class="tab-btn side-by-side-tab" data-target="side-by-side">Side by Side</button>
      <button class="tab-btn" data-target="latin-only">Latin Only</button>
      <button class="tab-btn" data-target="english-only">English Only</button>
    </div>
    
    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Analysis View -->
      <div id="analysis" class="tab-panel active">
        <div class="analysis-container">
          <div class="post-content analysis-content content-container" itemprop="articleBody">
            {{ content }}
          </div>
        </div>
      </div>
      
      <!-- Side by Side View -->
      <div id="side-by-side" class="tab-panel">
        <div class="two-columns">
          <div class="latin-column">
            <h3>Latin Original</h3>
            <div class="column-content" id="side-latin-content">
              {% if page.latin_text %}
                {{ page.latin_text | markdownify }}
              {% elsif page.translation_json %}
                {% for chunk in page.translation_json.chunks %}
                  <div class="chunk-section">
                    <span class="chunk-number">{{ chunk.chunk_number }}</span>
                    <div class="latin-text">
                      {{ chunk.original_latin | newline_to_br }}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="loading-indicator">Loading Latin text...</div>
              {% endif %}
            </div>
          </div>
          <div class="english-column">
            <h3>English Translation</h3>
            <div class="column-content" id="side-english-content">
              {% if page.english_translation %}
                {{ page.english_translation | markdownify }}
              {% elsif page.translation_json %}
                {% for chunk in page.translation_json.chunks %}
                  <div class="chunk-section">
                    <span class="chunk-number">{{ chunk.chunk_number }}</span>
                    <div class="english-text">
                      {% assign cleaned_text = chunk.cleaned_english_translation | replace: '<speak>', '' | replace: '</speak>', '' %}
                      {% assign cleaned_text = cleaned_text | replace: '<s>', '' | replace: '</s>', '' %}
                      {% assign cleaned_text = cleaned_text | replace: '<p>', '<p class="translation-paragraph">' %}
                      {% assign cleaned_text = cleaned_text | replace: '<break time="500ms"/>', '' %}
                      {{ cleaned_text }}
                    </div>
                  </div>
                {% endfor %}
              {% else %}
                <div class="loading-indicator">Loading English translation...</div>
              {% endif %}
            </div>
          </div>
        </div>
        <!-- Mobile alternative for side-by-side view -->
        <div class="mobile-translation-view">
          <div class="mobile-notice">
            <p>Side by side view is not available on small screens. Please use Latin Only or English Only views.</p>
          </div>
          <div class="mobile-navigation">
            <button class="mobile-nav-btn" data-target="latin-only">View Latin</button>
            <button class="mobile-nav-btn" data-target="english-only">View English</button>
          </div>
        </div>
      </div>
      
      <!-- Latin Only View -->
      <div id="latin-only" class="tab-panel">
        <h3>Latin Original</h3>
        <div class="single-column" id="latin-only-content">
          {% if page.latin_text %}
            {{ page.latin_text | markdownify }}
          {% elsif page.translation_json %}
            {% for chunk in page.translation_json.chunks %}
              <div class="chunk-section latin-full">
                <span class="chunk-number">{{ chunk.chunk_number }}</span>
                <div class="latin-text">
                  {{ chunk.original_latin | newline_to_br }}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="loading-indicator">Loading Latin text...</div>
          {% endif %}
        </div>
      </div>
      
      <!-- English Only View -->
      <div id="english-only" class="tab-panel">
        <h3>English Translation</h3>
        <div class="single-column" id="english-only-content">
          {% if page.english_translation %}
            {{ page.english_translation | markdownify }}
          {% elsif page.translation_json %}
            {% for chunk in page.translation_json.chunks %}
              <div class="chunk-section english-full">
                <span class="chunk-number">{{ chunk.chunk_number }}</span>
                <div class="english-text">
                  {% assign cleaned_text = chunk.cleaned_english_translation | replace: '<speak>', '' | replace: '</speak>', '' %}
                  {% assign cleaned_text = cleaned_text | replace: '<s>', '' | replace: '</s>', '' %}
                  {% assign cleaned_text = cleaned_text | replace: '<p>', '<p class="translation-paragraph">' %}
                  {% assign cleaned_text = cleaned_text | replace: '<break time="500ms"/>', '' %}
                  {{ cleaned_text }}
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="loading-indicator">Loading English translation...</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
  
  {% if page.youtube_id %}
  <div class="youtube-promo content-container">
    <h3>Enjoy this article? Listen to the translation!</h3>
    <p>Get the full experience of this Latin Patristic text.</p>
    <a href="https://www.youtube.com/watch?v={{ page.youtube_id }}" class="youtube-button" target="_blank">
      <svg class="youtube-icon" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M23,9.71a8.5,8.5,0,0,0-.91-4.13,2.92,2.92,0,0,0-1.72-1A78.36,78.36,0,0,0,12,4.27a78.45,78.45,0,0,0-8.34,.3,2.93,2.93,0,0,0-1.73,1A8.35,8.35,0,0,0,1,9.71a48.29,48.29,0,0,0,0,4.58a8.33,8.33,0,0,0,.92,4.13A3.09,3.09,0,0,0,3.66,19.5a78.24,78.24,0,0,0,8.34,.31,78.24,78.24,0,0,0,8.34-.31,3,3,0,0,0,1.73-1.07,8.32,8.32,0,0,0,.91-4.13,48.29,48.29,0,0,0,0-4.58ZM9.88,14.56V9.44l5.47,2.55Z"/>
      </svg>
      Watch on YouTube
    </a>
  </div>
  {% else %}
  <div class="youtube-promo content-container">
    <h3>Explore More Latin Patristic Texts</h3>
    <p>Discover more ancient wisdom through our video translations on YouTube.</p>
    <a href="{{ site.youtube_username | prepend: 'https://youtube.com/@' }}" class="youtube-button" target="_blank">
      <svg class="youtube-icon" viewBox="0 0 24 24" width="24" height="24">
        <path fill="currentColor" d="M23,9.71a8.5,8.5,0,0,0-.91-4.13,2.92,2.92,0,0,0-1.72-1A78.36,78.36,0,0,0,12,4.27a78.45,78.45,0,0,0-8.34,.3,2.93,2.93,0,0,0-1.73,1A8.35,8.35,0,0,0,1,9.71a48.29,48.29,0,0,0,0,4.58a8.33,8.33,0,0,0,.92,4.13A3.09,3.09,0,0,0,3.66,19.5a78.24,78.24,0,0,0,8.34,.31,78.24,78.24,0,0,0,8.34-.31,3,3,0,0,0,1.73-1.07,8.32,8.32,0,0,0,.91-4.13,48.29,48.29,0,0,0,0-4.58ZM9.88,14.56V9.44l5.47,2.55Z"/>
      </svg>
      Visit Our Channel
    </a>
  </div>
  {% endif %}
  
  <!-- Scholarly Discussion Section -->
  <div class="comments-section content-container">
    <h2>Scholarly Discussion</h2>
    <p class="discussion-intro">Share your insights, questions, or observations about this translation.</p>
    
    <div id="disqus_thread"></div>
    <script>
      var disqus_config = function () {
        // Use absolute URL without any special characters
        this.page.url = "{{ site.url | default: 'https://bibliothecarius-modernus.github.io' }}{{ page.url }}";
        // Use a simple identifier without special characters
        this.page.identifier = "{{ page.url | slugify }}";
      };
      (function() {
        var d = document, s = d.createElement('script');
        s.src = 'https://bibliothecarius-modernus.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the scholarly discussion.</noscript>
  </div>
  
  <div class="post-navigation content-container">
    <div class="post-nav-links">
      {% if page.previous.url %}
      <a class="prev-post" href="{{ page.previous.url | relative_url }}">
        <span class="nav-label">Previous</span>
        <span class="post-title">{{ page.previous.title | escape }}</span>
      </a>
      {% endif %}
      
      {% if page.next.url %}
      <a class="next-post" href="{{ page.next.url | relative_url }}">
        <span class="nav-label">Next</span>
        <span class="post-title">{{ page.next.title | escape }}</span>
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Optimized JavaScript for translation loading and caching -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // ----------------
      // Tab functionality
      // ----------------
      const tabButtons = document.querySelectorAll('.tab-btn');
      const tabPanels = document.querySelectorAll('.tab-panel');
      
      // Mobile navigation buttons
      const mobileNavButtons = document.querySelectorAll('.mobile-nav-btn');
      mobileNavButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          const targetId = this.getAttribute('data-target');
          document.querySelector('.tab-btn[data-target="' + targetId + '"]').click();
        });
      });
      
      // Set up tab switching
      tabButtons.forEach(function(button) {
        button.addEventListener('click', function() {
          // Get target panel id
          const targetId = this.getAttribute('data-target');
          
          // Remove active class from all buttons and panels
          tabButtons.forEach(function(btn) {
            btn.classList.remove('active');
          });
          
          tabPanels.forEach(function(panel) {
            panel.classList.remove('active');
          });
          
          // Add active class to clicked button and target panel
          this.classList.add('active');
          document.getElementById(targetId).classList.add('active');
          
          // Save preference to localStorage
          localStorage.setItem('preferredTab', targetId);
          
          // Trigger content load if needed
          loadContentIfNeeded(targetId);
        });
      });
      
      // Check for saved preference
      const savedTab = localStorage.getItem('preferredTab');
      const isMobile = window.innerWidth <= 768;
      
      if (savedTab && document.getElementById(savedTab)) {
        if (!(isMobile && savedTab === 'side-by-side')) {
          // Find the button for this tab
          const savedButton = document.querySelector('.tab-btn[data-target="' + savedTab + '"]');
          if (savedButton) {
            savedButton.click();
          }
        } else {
          // If we're on mobile and the saved tab is side-by-side, default to analysis
          const analysisButton = document.querySelector('.tab-btn[data-target="analysis"]');
          if (analysisButton) {
            analysisButton.click();
          }
        }
      } else {
        // Load content for the default active tab (analysis)
        loadContentIfNeeded('analysis');
      }
      
      // ----------------
      // Translation content loading with local storage caching
      // ----------------
      
      // Only initialize if we have translation content to load
      const pageSlug = window.location.pathname.replace(/\//g, '-').replace(/^-|-$/g, '');
      const cacheKey = 'translation_' + pageSlug;
      const cacheExpiry = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
      
      function loadContentIfNeeded(tabId) {
        // Skip if we have inline content already or this is the analysis tab
        if (tabId === 'analysis' || document.querySelector('.translation_json')) {
          return;
        }
        
        // Check if we need to load content
        const hasLoadingIndicators = document.querySelectorAll('.loading-indicator').length > 0;
        if (!hasLoadingIndicators) {
          return; // Content already loaded
        }
        
        // Try to get from cache first
        const cached = getFromCache(cacheKey);
        if (cached) {
          renderTranslationData(cached);
          return;
        }
        
        // Determine filename from page metadata or URL
        const translationFile = '{{ page.translation_file | default: "" }}' || 
                               pageSlug + '.json';
        
        // Set loading state
        document.querySelectorAll('.loading-indicator').forEach(el => {
          el.textContent = 'Loading translation...';
        });
        
        // Fetch the translation data
        fetch('/assets/translations/' + translationFile)
          .then(response => {
            if (!response.ok) {
              throw new Error('Translation file not found');
            }
            return response.json();
          })
          .then(data => {
            // Cache the result
            saveToCache(cacheKey, data);
            // Render the data
            renderTranslationData(data);
          })
          .catch(error => {
            console.error('Error loading translation:', error);
            document.querySelectorAll('.loading-indicator').forEach(el => {
              el.textContent = 'Translation could not be loaded. Please try again later.';
              el.classList.add('error');
            });
          });
      }
      
      function renderTranslationData(data) {
        if (!data || !data.chunks || !data.chunks.length) {
          console.error('Invalid translation data format');
          return;
        }
        
        // Create HTML for Latin sections
        const latinHTML = data.chunks.map(chunk => {
          return `
            <div class="chunk-section">
              <span class="chunk-number">${chunk.chunk_number}</span>
              <div class="latin-text">
                ${chunk.original_latin.replace(/\n/g, '<br>')}
              </div>
            </div>
          `;
        }).join('');
        
        // Create HTML for English sections
        const englishHTML = data.chunks.map(chunk => {
          // Clean up SSML tags
          let cleanedText = chunk.cleaned_english_translation
            .replace(/<speak>|<\/speak>/g, '')
            .replace(/<s>|<\/s>/g, '')
            .replace(/<p>/g, '<p class="translation-paragraph">')
            .replace(/<break time="\d+ms"\/>/g, '');
            
          return `
            <div class="chunk-section">
              <span class="chunk-number">${chunk.chunk_number}</span>
              <div class="english-text">
                ${cleanedText}
              </div>
            </div>
          `;
        }).join('');
        
        // Update all the content containers
        document.querySelectorAll('#side-latin-content, #latin-only-content').forEach(el => {
          el.innerHTML = latinHTML;
        });
        
        document.querySelectorAll('#side-english-content, #english-only-content').forEach(el => {
          el.innerHTML = englishHTML;
        });
      }
      
      // Cache utilities
      function saveToCache(key, data) {
        const item = {
          timestamp: Date.now(),
          data: data
        };
        try {
          localStorage.setItem(key, JSON.stringify(item));
        } catch (e) {
          console.warn('Could not save to localStorage:', e);
        }
      }
      
      function getFromCache(key) {
        try {
          const item = JSON.parse(localStorage.getItem(key));
          if (!item) return null;
          
          // Check if cache is still valid
          const age = Date.now() - item.timestamp;
          if (age > cacheExpiry) {
            localStorage.removeItem(key);
            return null;
          }
          
          return item.data;
        } catch (e) {
          console.warn('Could not read from localStorage:', e);
          return null;
        }
      }
      
      // Handle window resize to switch views if needed
      window.addEventListener('resize', function() {
        const currentActiveTab = document.querySelector('.tab-panel.active').id;
        const isMobileView = window.innerWidth <= 768;
        
        // If resizing to mobile view and side-by-side is active, switch to analysis
        if (isMobileView && currentActiveTab === 'side-by-side') {
          const analysisButton = document.querySelector('.tab-btn[data-target="analysis"]');
          if (analysisButton) {
            analysisButton.click();
          }
        }
        
        // Toggle visibility of side-by-side tab based on screen size
        const sideBySideTab = document.querySelector('.side-by-side-tab');
        if (sideBySideTab) {
          sideBySideTab.style.display = isMobileView ? 'none' : 'block';
        }
      });
      
      // Lazy load audio elements
      document.querySelectorAll('audio').forEach(audio => {
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              // Set src attribute only when in viewport
              const source = audio.querySelector('source');
              if (source && source.dataset.src) {
                source.src = source.dataset.src;
                audio.load();
                observer.unobserve(audio);
              }
            }
          });
        }, { rootMargin: '100px' });
        
        observer.observe(audio);
      });
    });
  </script>

  <!-- Inline critical CSS for better performance -->
  <style>
    /* Core responsive layout styles */
    .content-container {
      width: 100%;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
      padding-left: 20px;
      padding-right: 20px;
    }
    
    @media (max-width: 840px) {
      .content-container {
        padding-left: 15px;
        padding-right: 15px;
      }
    }
    
    /* Critical tab interface styles */
    .translation-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;
      margin-bottom: 1px;
      border-bottom: 2px solid #B8860B;
    }
    
    .tab-btn {
      flex: 1;
      min-width: min-content;
      white-space: nowrap;
      padding: 8px 16px;
      margin-right: 4px;
      background-color: #EDE0CA;
      border: 1px solid #B8860B;
      border-bottom: none;
      border-radius: 4px 4px 0 0;
      color: #3E2C1B;
      cursor: pointer;
      font-weight: normal;
      transition: background-color 0.2s;
    }
    
    .tab-btn:hover {
      background-color: #e3d6c0;
    }
    
    .tab-btn.active {
      background-color: #B8860B;
      color: white;
      font-weight: bold;
    }
    
    .analysis-tab {
      background-color: #3E2C1B;
      color: #EDE0CA;
    }
    
    .analysis-tab:hover {
      background-color: #4d372a;
    }
    
    .analysis-tab.active {
      background-color: #3E2C1B;
      color: #EDE0CA;
    }
    
    .tab-content {
      border: 1px solid #B8860B;
      border-top: none;
      background-color: white;
    }
    
    .tab-panel {
      display: none;
      padding: 15px;
    }
    
    .tab-panel.active {
      display: block;
    }
    
    #analysis {
      padding: 0;
      border: none;
      background-color: transparent;
    }
    
    /* Responsive embed for YouTube */
    .responsive-embed {
      position: relative;
      width: 100%;
      padding-bottom: 56.25%; /* 16:9 aspect ratio */
      height: 0;
      overflow: hidden;
    }
    
    .responsive-embed iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Loading indicators */
    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #666;
      background-color: #f8f8f8;
      border-radius: 6px;
    }
    
    .loading-indicator.error {
      background-color: #fff0f0;
      color: #a00;
    }
    
    /* Mobile translation view */
    @media (max-width: 767px) {
      .side-by-side-tab {
        display: none;
      }
      
      #side-by-side .two-columns {
        display: none;
      }
      
      #side-by-side .mobile-translation-view {
        display: block;
      }
      
      .mobile-notice {
        background-color: #fff8e8;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 15px;
        border: 1px solid #B8860B;
      }
      
      .mobile-navigation {
        display: flex;
        justify-content: space-around;
        margin-top: 10px;
      }
      
      .mobile-nav-btn {
        padding: 10px 20px;
        background-color: #3E2C1B;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        transition: background-color 0.2s;
      }
    }
  </style>
</article>